@* temp import until dto is finished
 *@
@using Howest.MagicCards.DAL.Models;
@inject IHttpClientFactory httpClientFactory

<div>
    <h2>deck</h2>

    <p class="error">@message</p>
    <div class="deck">
        @if (deckCards != null && deckCards.Any())
        {
            <div id="listOfDeckCards">
                @foreach (DeckCard card in deckCards)
                {                    
                    <button onclick="(() => @removeCardFromDeck(card))"> - </button>
                    <div class="deckName">@card.name</div>
                    <div class="deckAmount">@card.amount</div>                    
                }
            </div>          
        }
        else
        {
                <p>no cards in your deck yet...</p>
        }
    </div>
</div>

@code {
    string message { get; set; }
    public IEnumerable<DeckCard> deckCards { get; set; }
    private JsonSerializerOptions JsonOptions { get; }

    public DeckCards()
    {
        JsonOptions = new JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true,
            };
    }

    protected override async Task OnInitializedAsync()
    {
        await getDeck();
    }

    private async Task getDeck()
    {
        HttpClient httpClient = httpClientFactory.CreateClient("MinimalAPI");

        HttpResponseMessage response = await httpClient.GetAsync("");

        string apiResponse = await response.Content.ReadAsStringAsync();

        if (response.IsSuccessStatusCode)
        {
            deckCards = JsonSerializer.Deserialize<IEnumerable<DeckCard>>(apiResponse, JsonOptions);
        }
        else
        {
            message = $"Error: {response.ReasonPhrase}";
        }
    }

    public async Task removeCardFromDeck(DeckCard card)
    {

    }

    public async Task AddCardToDeck(DeckCard card)
    {
        HttpClient httpClient = httpClientFactory.CreateClient("MinimalAPI");
        var content = new StringContent(string.Empty);

        HttpResponseMessage response = await httpClient.PutAsync($"add?id={card.id}_{card.name}&name={card.name}", content);

        if (response.IsSuccessStatusCode)
        {
            getDeck();
        }
        else
        {
            message = $"Error: {response.ReasonPhrase}";
        }
    }

}